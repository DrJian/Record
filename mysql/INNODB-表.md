## 关于主键的选择

在没有显示定义主键的情况下，按照以下两种条件进行选择：

1.  如果有非空的唯一键（UNIQUE NOT NULL），该列即为主键
2.  不满足上述，创建一个6字节大小的指针

## InnoDB存储的逻辑结构

一个数据库表的空间逻辑排列由上到下为 表(Table)->段(Segment)->区(Extent)->Block(块)/Page(页)  在Oracle最下面一层的逻辑结构为Block(块)，在InnoDB中叫作页(Page)

### InnoDB表空间文件

存放数据表的实际数据的文件，后缀为.ibd，`show variables like '%innodb_file_per_table%';`这个变量开启，我们会为每个db的table存储一个文件，路径参考`show variables like '%datadir%;`在同目录下还会有表结构的定义文件，后缀.frm

###关于size限制

#### varchar

关于varchar(N)类型的字段，长度限制N指的是字符数，对于ascii编码，和字节数是相等的，但是对于GBK,UTF8则分别对应2N,3N字节数，varchar的最大长度为65535个字节，这取决于此InnoDB标的行存储格式，在5.1流行的Compact行存储中，针对变长列的长度记录规则如下：

>   长度小于255使用一个字节，长度大于255使用两个字节，所以两个字节的最大长度记录为2^16-1=65535

#### InnoDB表限制

-   InnoDB数据表最多仅能拥有1017个column
-   每一行的所有字段共享行最大size值，如下建表语句会直接报错，由于长度超过最大值create table test(a varchar(60000), b varchar(5536)) engine=innodb charset=latin1;`

#### InnoDB行限制

尽管不同数据库引擎实际存储数据的方式不同，引擎之间对于行数据的支持不尽相同，但是mysql内部对于行的大小限制为65535字节。比如InnoDB引擎的行限制为page(页)大小的一半略小，16KB的页大小允许Row size达到8000+bytes，但是由于mysql本身的限制，不能超过65535bytes，所以这里就只能是65535字节，当然也会受到物理Row的存储格式影响。

不同的`row_format`也会影响表行的存储，因为不同的模式物理文件每行的记录方式有差异，可查看`innodb_default_row_format`变量查看默认值，针对特定表，执行`show table status`。

#### InnoDB页大小限制

查看`innodb_page_size`变量的设定，一般默认为16KB。

### InnoDB行模式

#### 通用概念

-   Clustered Indexs(聚簇索引)，通常为主键，在没有主键的情况下，生成6字节的RowId作为索引key，最大的特点是顺序性，聚簇索引记录的逻辑顺序与物理存储顺序一致，小->大
-   Secondary Indexs(非聚簇索引)，逻辑顺序与武林顺序无关系，比如非主键column N，N的大小与实际存储位置的先后无关联。

#### Redundant Row Format Characteristics

-   可以兼容旧版本(<5.0)mysql InnoDB的格式
-   每一行都包含一个6字节的头，用来链接连续的记录(类似链表的概念，包括下一行记录开始位置相对于本行开始位置的偏移量)以及行锁定。
-   6字节事务id，7字节回滚指针
-   无主键情况下，包含一个6字节RowId
-   非聚簇索引中如果不包括相关聚簇索引的主键，则将主键值同时记录在非聚簇索引中。
-   记录字典？每个记录都包含一个指向所有字段的二阶指针，**待确认**。
-   变长类型不补全值，根据实际长度存储。
-   对于长度超过768byte的定长字段，会被当做变长类型对待。
-   NULL值会花费1或2字节存储，如果是变长字段，不销号额外空间，在头信息中即可解决。

#### COMPACT Row Format Characteristics

>与Redundant相比，节省了文件空间，但是增加了CPU负担，如果是缓存命中或磁盘IO能力短板的系统，使用这个格式，可以获得更多的收益。但是如果是CPU计算能力短板类型的系统，使用此格式反而会降低性能。

-   每一行包含一个5字节的记录头，版本不同，可能位于变长字段列表前面，用于关联行记录以及行锁定。
-   变量长度信息部分，对NULL的判断，如果有N个字段可能为NULL，则此部分长度为(N/8)byte，为NULL的字段除了在NULL part占据一个Bit外，不占据其他空间。变量长度信息包括变长字段长度信息的记录，固定长度的字段无此信息，如果表无变长列且都为定长类型，则记录头无此部分。
-   记录头内容后面紧跟的就是非NULL的字段值。
-   聚簇索引包含了所有的用户定义列，除此以外，还有6字节的事务id以及7字节的回滚指针值。
-   如果表无主键，则使用6字节的RowId
-   ​